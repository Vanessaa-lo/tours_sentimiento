<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard de Sentimientos</title>

  <link rel="stylesheet" href="/ui/styles.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="dashboard">
  <main class="dashboard-container">
    <header class="dashboard-header">
      <h1>üìä Dashboard de Sentimientos</h1>
      <a href="/" class="link-volver">‚Üê Volver al analizador</a>
    </header>

    <!-- RESUMEN GENERAL -->
    <section id="stats-panel" class="stats-panel">
      <div class="stats-panel-header">
        <h2>Resumen general</h2>
        <a href="/descargar_resenas" class="btn-export" download>
          ‚¨áÔ∏è Descargar rese√±as (CSV)
        </a>
        <a href="/descargar_resenas_excel" class="btn-export" download>
          ‚¨áÔ∏è Descargar rese√±as (Excel)
        </a>

      </div>


      <div class="stats-grid">
        <div class="stat-card stat-total">
          <span class="stat-label">Total rese√±as</span>
          <span class="stat-value" id="stat-total">0</span>
        </div>

        <div class="stat-card stat-pos">
          <span class="stat-label">Positivas</span>
          <span class="stat-value" id="stat-pos">0</span>
          <span class="stat-sub" id="stat-pos-pct">0%</span>
        </div>

        <div class="stat-card stat-neu">
          <span class="stat-label">Neutrales</span>
          <span class="stat-value" id="stat-neu">0</span>
          <span class="stat-sub" id="stat-neu-pct">0%</span>
        </div>

        <div class="stat-card stat-neg">
          <span class="stat-label">Negativas</span>
          <span class="stat-value" id="stat-neg">0</span>
          <span class="stat-sub" id="stat-neg-pct">0%</span>
        </div>
      </div>

      <p class="stats-updated">
        √öltima actualizaci√≥n: <span id="stats-updated">‚Äî</span>
      </p>
    </section>

    <!-- FILTROS POR FECHA -->
    <section class="filters-section">
      <h2>Filtros</h2>
      <div class="filters-grid">
        <label>
          Desde:
          <input type="date" id="filtro-desde" />
        </label>
        <label>
          Hasta:
          <input type="date" id="filtro-hasta" />
        </label>
        <button id="btn-aplicar-filtro" class="btn-filter">Aplicar filtro</button>
        <button id="btn-limpiar-filtro" class="btn-filter-secondary">Quitar filtro</button>
      </div>
    </section>


    <!-- GR√ÅFICAS -->
    <section class="charts-section">
      <h2>Distribuci√≥n de sentimientos</h2>

      <div class="charts-grid">
        <div class="chart-card">
          <h3>Dona de sentimientos</h3>
          <canvas id="sentimentDonut"></canvas>
        </div>

        <div class="chart-card">
          <h3>Tendencia por d√≠a</h3>
          <canvas id="trendChart"></canvas>
        </div>

        <div class="chart-card">
          <h3>Total por dia</h3>
          <div class="chart-wrapper">
            <canvas id="sentimentTrendChart"></canvas>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- SCRIPT INLINE DEL DASHBOARD -->
    <script>
    let donutChart = null;
    let trendChart = null;
    let totalChart = null;

    document.addEventListener("DOMContentLoaded", () => {
      // Cargar dashboard completo sin filtros al inicio
      cargarDashboard();

      // Bot√≥n aplicar filtro
      document.getElementById("btn-aplicar-filtro").addEventListener("click", () => {
        const desde = document.getElementById("filtro-desde").value;
        const hasta = document.getElementById("filtro-hasta").value;
        cargarDashboard(desde, hasta);
      });

      // Bot√≥n quitar filtro
      document.getElementById("btn-limpiar-filtro").addEventListener("click", () => {
        document.getElementById("filtro-desde").value = "";
        document.getElementById("filtro-hasta").value = "";
        cargarDashboard();
      });
    });

    async function cargarDashboard(desde = "", hasta = "") {
      console.log("üîÑ Cargando dashboard con rango:", { desde, hasta });

      // ===== 1) Stats (tarjetas) =====
      try {
        let urlStats = "/stats";
        if (desde || hasta) {
          const params = new URLSearchParams();
          if (desde) params.append("desde", desde);
          if (hasta) params.append("hasta", hasta);
          urlStats = "/stats_rango?" + params.toString();
        }

        const respStats = await fetch(urlStats);
        if (respStats.ok) {
          const stats = await respStats.json();
          actualizarTarjetas(stats);
        } else {
          console.warn("No se pudieron cargar stats");
        }
      } catch (e) {
        console.error("‚ùå Error al pedir stats:", e);
      }

      // ===== 2) Series para gr√°ficas =====
      let series = [];
      try {
        let urlSeries = "/stats_series";
        if (desde || hasta) {
          const params = new URLSearchParams();
          if (desde) params.append("desde", desde);
          if (hasta) params.append("hasta", hasta);
          urlSeries = "/stats_series_rango?" + params.toString();
        }

        const respSeries = await fetch(urlSeries);
        if (respSeries.ok) {
          series = await respSeries.json();
        } else {
          console.warn("No se pudieron cargar stats_series");
        }
      } catch (e) {
        console.error("‚ùå Error al pedir stats_series:", e);
      }

      renderGraficas(series);
    }

    // ===== Actualizar tarjetas resumen =====
    function actualizarTarjetas(stats) {
      const elTotal = document.getElementById("stat-total");
      const elPos = document.getElementById("stat-pos");
      const elNeu = document.getElementById("stat-neu");
      const elNeg = document.getElementById("stat-neg");

      const elPosPct = document.getElementById("stat-pos-pct");
      const elNeuPct = document.getElementById("stat-neu-pct");
      const elNegPct = document.getElementById("stat-neg-pct");

      const elUpdated = document.getElementById("stats-updated");

      elTotal.textContent = stats.total ?? 0;
      elPos.textContent = stats.positivos ?? 0;
      elNeu.textContent = stats.neutrales ?? 0;
      elNeg.textContent = stats.negativos ?? 0;

      elPosPct.textContent = (stats.porc_positivos ?? 0).toFixed(2) + "%";
      elNeuPct.textContent = (stats.porc_neutrales ?? 0).toFixed(2) + "%";
      elNegPct.textContent = (stats.porc_negativos ?? 0).toFixed(2) + "%";

      if (stats.ultima_actualizacion) {
        const fecha = new Date(stats.ultima_actualizacion).toLocaleString("es-MX", {
          dateStyle: "short",
          timeStyle: "short",
        });
        elUpdated.textContent = fecha;
      } else {
        elUpdated.textContent = "‚Äî";
      }
    }

    // ===== Crear / actualizar gr√°ficas =====
    function renderGraficas(series) {
      // Preparar datos
      let dias = [];
      let posPorDia = [];
      let neuPorDia = [];
      let negPorDia = [];
      let totalPorDia = [];

      if (series && series.length > 0) {
        dias = series.map((punto) => {
          const [year, month, day] = punto.fecha.split("-").map(Number);
          const d = new Date(year, month - 1, day);
          return d.toLocaleDateString("es-MX", {
            day: "2-digit",
            month: "short",
          });
        });

        posPorDia = series.map((p) => p.positivos);
        neuPorDia = series.map((p) => p.neutrales);
        negPorDia = series.map((p) => p.negativos);
        totalPorDia = series.map((p) => p.total);
      } else {
        dias = ["Sin datos"];
        posPorDia = [0];
        neuPorDia = [0];
        negPorDia = [0];
        totalPorDia = [0];
      }

      // ===== Gr√°fica de dona =====
      const canvasDonut = document.getElementById("sentimentDonut");
      if (canvasDonut) {
        const ctx = canvasDonut.getContext("2d");

        // destruimos si ya existe
        if (donutChart) donutChart.destroy();

        const totalPos = posPorDia.reduce((a, b) => a + b, 0);
        const totalNeu = neuPorDia.reduce((a, b) => a + b, 0);
        const totalNeg = negPorDia.reduce((a, b) => a + b, 0);
        const dataValues = [totalPos, totalNeu, totalNeg];
        const totalAll = totalPos + totalNeu + totalNeg || 1;

        donutChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Positivas", "Neutrales", "Negativas"],
            datasets: [
              {
                data: dataValues,
                backgroundColor: [
                  "rgba(74, 222, 128, 0.7)",
                  "rgba(129, 140, 248, 0.7)",
                  "rgba(248, 113, 113, 0.7)",
                ],
                borderColor: [
                  "rgba(34, 197, 94, 1)",
                  "rgba(79, 70, 229, 1)",
                  "rgba(239, 68, 68, 1)",
                ],
                borderWidth: 1,
                hoverOffset: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "60%",
          },
        });
      }

      // ===== Gr√°fica de l√≠neas POS / NEU / NEG =====
      const trendCanvas = document.getElementById("trendChart");
      if (trendCanvas) {
        const trendCtx = trendCanvas.getContext("2d");
        if (trendChart) trendChart.destroy();

        trendChart = new Chart(trendCtx, {
          type: "line",
          data: {
            labels: dias,
            datasets: [
              {
                label: "Positivas",
                data: posPorDia,
                borderWidth: 2,
                tension: 0.3,
                borderColor: "rgba(74, 222, 128, 1)",
                backgroundColor: "rgba(74, 222, 128, 0.3)",
              },
              {
                label: "Neutrales",
                data: neuPorDia,
                borderWidth: 2,
                tension: 0.3,
                borderColor: "rgba(129, 140, 248, 1)",
                backgroundColor: "rgba(129, 140, 248, 0.3)",
              },
              {
                label: "Negativas",
                data: negPorDia,
                borderWidth: 2,
                tension: 0.3,
                borderColor: "rgba(248, 113, 113, 1)",
                backgroundColor: "rgba(248, 113, 113, 0.3)",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  maxRotation: 0,
                  minRotation: 0,
                },
              },
            },
          },
        });
      }

      // ===== Gr√°fica de barras TOTAL por d√≠a =====
      const totalCanvas = document.getElementById("sentimentTrendChart");
      if (totalCanvas) {
        const totalCtx = totalCanvas.getContext("2d");
        if (totalChart) totalChart.destroy();

        totalChart = new Chart(totalCtx, {
          type: "bar",
          data: {
            labels: dias,
            datasets: [
              {
                label: "Total de rese√±as por d√≠a",
                data: totalPorDia,
                borderWidth: 1,
                backgroundColor: "rgba(129, 140, 248, 0.5)",
                borderColor: "rgba(79, 70, 229, 1)",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  maxRotation: 0,
                  minRotation: 0,
                },
              },
            },
          },
        });
      }
    }
  </script>
</body>
</html>